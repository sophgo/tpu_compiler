# python_tools

## overview

A collection of python tools for debugging. The MLIR TPU dialect tensor saving and loading are based on npy and npz file format, which can be easily manipulated by python numpy functions. npz file is just zip of a bunch of npy files, we can just run `unzip` to save a npz into separate npy files.

## utilites commands

* npz_list.py

List arrayname of all arrays in the npz file
```
$ python npz_list.py file.npz
```

* npz_dump.py

Dump one array from the npz file. Show top-k if [K] is provided.
```
$ python npz_dump.py file.npz arrayname [K]
```

* npz_to_bin.py

Save one array from the npz file into a binary file.
```
$ python npz_to_bin.py file.npz arrayname
```

* npy_dump.py

Dump a npy file. Show top-k if [K] is provided.
```
$ python npy_dump.py file.npy [K]
```

* npy_to_bin.py

Save the array from a npy file into a binary file.
```
$ python npy_to_bin.py file.npy out.bin
```

* bin_dump.py

Dump a binary file.
```
$ python bin_dump.py file.bin int8|float32 N C H W [K]
```

* bin_to_npy.py

Save a binary file into a npy file. Show top-k if [K] is provided.
```
$ python bin_to_npy.py file.bin int8|float32 N C H W
```

* bin_fp32_to_int8.py

Convert a fp32 binary file into a int8 binary file.
```
$ python bin_fp32_to_int8.py fp32.bin int8.bin [input_scale] [threshold]
```

* bin_fp32_to_bf16.py

Convert a fp32 binary file into a bf16 binary file.
```
$ python bin_fp32_to_int8.py fp32.bin bf16.bin [input_scale]
```

## caffe commands

The blobs dump will dump all final blob data. However, intermidiate results of inplace computation are overwriten. To workaround, to edit the deploy.prototxt manually, unfold the inplace nodes.

Run inference with fp32 model. If `--dump_weight` is provided, a weight npz file is generated, which should be identical with the weight npz generated by mlir-translate.

To match the previous input/output data. Feed input data with `--force-input` argument.

```
$ run_caffe_classifier.py \
    --model_def $MODEL_PATH/caffe/ResNet-50-deploy.prototxt \
    --pretrained_model $MODEL_PATH/caffe/ResNet-50-model.caffemodel \
    --mean_file $PYTHON_TOOLS_PATH/data/ilsvrc_2012_mean.npy \
    --label_file $PYTHON_TOOLS_PATH/data/ilsvrc12/synset_words.txt \
    --dump_blobs resnet50_blobs.npz \
    --dump_weights resnet50_weights.npz \
    $PYTHON_TOOLS_PATH/data/images/cat.jpg \
    caffe_out.npy

$ bin_to_npy.py $DATA_PATH/test_cat_in_fp32.bin float32 1 3 224 224 \
    resnet50_input_fp32.npy
$ run_caffe_classifier.py \
    --model_def $MODEL_PATH/caffe/ResNet-50-deploy.prototxt \
    --pretrained_model $MODEL_PATH/caffe/ResNet-50-model.caffemodel \
    --mean_file $PYTHON_TOOLS_PATH/data/ilsvrc_2012_mean.npy \
    --label_file $PYTHON_TOOLS_PATH/data/ilsvrc12/synset_words.txt \
    --dump_blobs resnet50_blobs.npz \
    --dump_weights resnet50_weights.npz \
    --force_input resnet50_input_fp32.npy \
    $PYTHON_TOOLS_PATH/data/images/cat.jpg \
    caffe_out.npy
$ bin_compare.py caffe_out.bin $DATA_PATH/test_cat_out_resnet50_prob_fp32.bin \
    float32 1 1 1 1000 5
```

mobilenet-v2
```
$ run_caffe_classifier.py \
    --model_def $MODEL_PATH/caffe/mobilenet_v2_deploy.prototxt \
    --pretrained_model $MODEL_PATH/caffe/mobilenet_v2.caffemodel \
    --mean 103.94,116.78,123.68 \
    --input_scale 0.017 \
    --label_file $PYTHON_TOOLS_PATH/data/ilsvrc12/synset_words.txt \
    --dump_blobs mobilenet_v2_blobs.npz \
    --dump_weights mobilenet_v2_weights.npz \
    $PYTHON_TOOLS_PATH/data/images/cat.jpg \
    caffe_out.npy
```

yolo-v3
```
$ run_caffe_detector_yolo.py \
    --model_def $MODEL_PATH/caffe/yolov3/416/yolov3_416.prototxt \
    --pretrained_model $MODEL_PATH/caffe/yolov3/416/yolov3_416.caffemodel \
    --net_input_dims 416,416 \
    --obj_threshold 0.3 \
    --nms_threshold 0.5 \
    --dump_blobs yolov3_blobs.npz \
    --dump_weights yolov3_weights.npz \
    --input_file $PYTHON_TOOLS_PATH/data/yolo/dog.jpg \
    --label_file $PYTHON_TOOLS_PATH/data/coco-labels-2014_2017.txt \
    --draw_image out.jpg
$ feh out.jpg
```

```
$ eval_caffe_detector_yolo.py \
    --model_def $MODEL_PATH/caffe/yolov3/416/yolov3_416.prototxt \
    --pretrained_model $MODEL_PATH/caffe/yolov3/416/yolov3_416.caffemodel \
    --net_input_dims 416,416 \
    --obj_threshold 0.005 \
    --nms_threshold 0.45 \
    --dataset=$DATASET_PATH/coco/val2017 \
    --annotations=$DATASET_PATH/coco/annotations/instances_val2017.json \
    --result_json=result_416.json
    --count=100

$ eval_caffe_detector_yolo.py \
    --model_def $MODEL_PATH/caffe/yolov3/608/yolov3_608.prototxt \
    --pretrained_model $MODEL_PATH/caffe/yolov3/608/yolov3_608.caffemodel \
    --net_input_dims 608,608 \
    --obj_threshold 0.005 \
    --nms_threshold 0.45 \
    --dataset=$DATASET_PATH/coco/val2017 \
    --annotations=$DATASET_PATH/coco/annotations/instances_val2017.json \
    --result_json=result_608.json \
    --count=100
```
